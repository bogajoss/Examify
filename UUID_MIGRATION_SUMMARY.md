# UUID Migration to PostgreSQL Extension

## Summary
Migrated all UUID generation from application-level (TypeScript) to database-level (PostgreSQL `uuid-ossp` extension). This improves security, consistency, and removes code complexity.

## Changes Made

### 1. Database Schema (supabase.sql)
✅ Already configured with:
- `uuid-ossp` extension enabled
- All UUID primary keys use `uuid_generate_v4()` as DEFAULT value
- Automatic UUID generation on INSERT

### 2. Application Code Updates

#### src/lib/supabase.ts
- ✅ Deprecated `generateUUID()` function with warning log
- Kept for backward compatibility but not used anywhere
- All new UUID generation delegated to database

#### src/app/api/files/route.ts
- ✅ Removed `generateUUID` import
- ✅ POST endpoint: Removed `id: file_id` from INSERT
- Database now automatically generates UUID via default value

#### src/app/api/tokens/route.ts
- ✅ Removed `generateUUID` import
- ✅ POST endpoint: Removed `id: token_id` from INSERT
- Token generation still uses application-level random string (not UUID)
- Database auto-generates UUID for token ID

#### src/app/api/questions/route.ts
- ✅ Removed `generateUUID` import
- ✅ POST endpoint: Removed `id: question_id` from INSERT
- Removed `created_at` from INSERT (database uses DEFAULT)
- Default file creation: Removed `id: finalFileId` from file INSERT

#### src/app/api/upload-csv/route.ts
- ✅ Removed `generateUUID` import
- ✅ File creation: Removed `id: file_id` from INSERT
- ✅ Question batch insert: Removed `id` and `created_at` from all question records
- Database auto-generates UUID for each question

## Benefits

1. **Security**: UUIDs generated by PostgreSQL are cryptographically secure
2. **Consistency**: Centralized UUID generation in one place (database)
3. **Performance**: Eliminates UUID generation on every application request
4. **Simplicity**: Less code in application layer
5. **Database-first**: Schema acts as single source of truth

## Verification

All files updated successfully:
- ✅ No `generateUUID()` calls in any API route files
- ✅ All INSERT statements omit `id` field for UUID columns
- ✅ Database schema already has proper defaults configured
- ✅ Deprecated function marked for future removal

## Migration Status

**COMPLETE** ✅

All INSERT operations now rely on PostgreSQL's `uuid_generate_v4()` function via DEFAULT values. The application no longer generates UUIDs; this responsibility is entirely with the database.

## Testing Checklist

- [ ] Create new file via POST /api/files
- [ ] Create new question via POST /api/questions
- [ ] Create new token via POST /api/tokens
- [ ] Upload CSV file via POST /api/upload-csv
- [ ] Verify all generated IDs are valid UUIDs (v4 format)
- [ ] Verify database query logs show uuid_generate_v4() execution

## Future Work

- Remove deprecated `generateUUID()` function after ensuring no external code depends on it
- Update API documentation to reflect database-generated UUIDs
- Consider adding UUID validation in API responses (optional)
