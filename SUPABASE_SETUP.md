# Examify - Supabase Migration Complete

## Overview
The Examify project has been fully migrated from MySQL to Supabase PostgreSQL database. This document provides setup instructions and verification checklist.

## Environment Variables

Create a `.env.local` file in the project root with the following variables:

```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=your-publishable-key-here

# Optional: CSV API Backend (if using legacy PHP backend)
NEXT_PUBLIC_CSV_API_BASE_URL=https://your-backend.com
NEXT_PUBLIC_CSV_API_KEY=your-api-key-here
```

### Getting Supabase Keys

1. Go to your Supabase project dashboard
2. Navigate to **Settings > API**
3. Copy the following:
   - **URL**: Project URL
   - **Anon Key**: Public/Anonymous Key (use for client-side)
   - **Service Role Key**: Secret key (use only in server-side operations)

## Database Schema

The database includes the following tables:

### Core Tables
- **users**: Student accounts with enrollment tracking
- **admins**: Administrator and moderator accounts
- **batches**: Student batch/course groups
- **exams**: Exam configurations and metadata
- **files**: Uploaded question banks
- **questions**: Individual exam questions

### Relationship Tables
- **exam_questions**: Links questions to exams
- **student_exams**: Student exam attempts and results
- **student_responses**: Individual student answer responses
- **api_tokens**: API authentication tokens

### Supporting Tables
- **categories**: Question bank categories
- **daily_records**: Student daily statistics
- **student_attendance**: Attendance tracking
- **student_tasks**: Daily task submissions

## Key Features

### 1. Row Level Security (RLS)
All tables have RLS enabled with appropriate policies:
- **Read Access**: Depends on table (public, authenticated, or own data)
- **Write Access**: Primarily through service role (backend) and admin actions

### 2. Triggers
Automatic timestamp updates for:
- `admins.updated_at`
- `batches.updated_at`
- `users.updated_at`
- `exams.updated_at`
- `student_tasks.updated_at`

### 3. Constraints
- UUID primary keys (generated by PostgreSQL)
- Foreign key relationships with cascading deletes
- NOT NULL constraints on required fields
- CHECK constraints for data validation
- UNIQUE constraints for roll numbers and other fields

### 4. Indexes
Optimized indexes on:
- Foreign keys
- Frequently searched fields (status, dates, roll)
- Array fields (enrolled_batches)
- Composite indexes for common query patterns

## Architecture

### Client-Side (Frontend)
- Uses `NEXT_PUBLIC_SUPABASE_ANON_KEY` for authentication
- Limited by RLS policies
- Can read public data and own data

### Server-Side (Backend)
- Uses `SUPABASE_SERVICE_ROLE_KEY` for full access
- Can perform all CRUD operations
- Used in:
  - Server actions (`src/lib/actions.ts`)
  - API routes (`src/app/api/*/route.ts`)
  - Server components

### Data Functions
Located in `src/lib/`:
- `supabase.ts`: Client configuration and type definitions
- `data-supabase.ts`: Core data fetching functions
- `actions.ts`: Server actions for creating/updating data
- `users-supabase.ts`: User-related functions
- `stats-supabase.ts`: Statistics functions
- `reports-supabase.ts`: Report generation
- `daily-supabase.ts`: Daily operations

## Setup Instructions

### 1. Clone and Install
```bash
cd /workspaces/codespaces-blank/Examify
pnpm install
```

### 2. Configure Environment
Copy your Supabase credentials to `.env.local`

### 3. Run Migrations
Apply the database migration to your Supabase project:

```sql
-- Copy contents of migrations/20260104_supabase_complete_setup.sql
-- and execute in Supabase SQL Editor
```

Or use Supabase CLI:
```bash
supabase db push
```

### 4. Create Admin Account
Connect to Supabase and insert admin user:

```sql
INSERT INTO admins (username, password, name, role) 
VALUES ('admin', 'password123', 'Administrator', 'admin');
```

### 5. Generate API Token (Optional)
For external API access:

```sql
INSERT INTO api_tokens (token, name, is_active, is_admin) 
VALUES ('your-secret-token-here', 'External API', true, true);
```

### 6. Start Development Server
```bash
pnpm dev
```

Visit `http://localhost:3000`

## API Routes

### Public Routes
- `/api/fetch-questions`: Get questions (with filters)
- `/api/files`: Get question files
- `/api/stats`: Get public statistics

### Protected Routes (Require API Token)
- `/api/questions`: CRUD operations on questions
- `/api/upload-csv`: Upload CSV files
- `/api/tokens`: Manage API tokens

### Server Actions (Backend Only)
- `createUser`: Create new student
- `createBatch`: Create new batch
- `createExam`: Create new exam
- `uploadCSVAction`: Upload question bank

## Common Operations

### Create a Student
```typescript
const formData = new FormData();
formData.append('name', 'John Doe');
formData.append('roll', '2024-001');
formData.append('pass', 'student123');
formData.append('batch_id', 'batch-uuid');
formData.append('passwordMode', 'manual');

const result = await createUser(formData);
```

### Upload Questions
```typescript
const formData = new FormData();
formData.append('csv_file', csvFile);
formData.append('is_bank', '1');

const result = await uploadCSVAction(formData);
```

### Create Exam
```typescript
const formData = new FormData();
formData.append('name', 'Final Exam');
formData.append('batch_id', 'batch-uuid');
formData.append('file_id', 'file-uuid');
formData.append('duration_minutes', '120');
formData.append('marks_per_question', '1');
formData.append('question_ids', JSON.stringify(questionIds));

const result = await createExam(formData);
```

## Verification Checklist

- [ ] Supabase project created
- [ ] Environment variables configured
- [ ] Database migrations applied
- [ ] Admin account created
- [ ] API tokens generated (if needed)
- [ ] Development server running
- [ ] Admin login works
- [ ] Student login works
- [ ] CSV upload works
- [ ] Exam creation works
- [ ] Question fetching works
- [ ] Student exam submission works
- [ ] Results display works

## Troubleshooting

### Connection Issues
```typescript
// Test Supabase connection
import { supabase } from '@/lib/supabase';
const { data, error } = await supabase.from('batches').select('count');
console.log(data, error);
```

### Authentication Issues
- Check JWT tokens in browser DevTools > Application > Cookies
- Verify `NEXT_PUBLIC_SUPABASE_ANON_KEY` in `.env.local`
- Check RLS policies in Supabase dashboard

### Database Errors
- Check table names match exactly (case-sensitive)
- Verify foreign key relationships
- Check RLS policies allow the operation
- Review Supabase logs in dashboard

## Performance Tips

1. **Use Appropriate Indexes**: Already configured in migrations
2. **Pagination**: Use `.range()` for large result sets
3. **Selective Columns**: Use `.select('specific, columns')` instead of `*`
4. **Batch Operations**: Use `.insert(array)` for multiple records
5. **Connection Pooling**: Supabase handles this automatically

## Security

1. **Never commit `.env.local`**: Add to `.gitignore`
2. **Service Role Key**: Only use server-side, never expose to client
3. **RLS Policies**: Keep enabled on all tables
4. **API Tokens**: Rotate regularly
5. **Password Storage**: Currently plain text for compatibility, consider hashing

## Next Steps

1. Test all features thoroughly
2. Set up monitoring and logging
3. Configure backups
4. Set up CI/CD deployment
5. Performance testing with production load
6. Security audit of RLS policies

## Support

For Supabase documentation: https://supabase.com/docs
For Next.js documentation: https://nextjs.org/docs
